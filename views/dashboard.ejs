<%- include('partials/head') %>
    <div class="flex h-screen overflow-hidden">
        <%- include('partials/sidebar', { currentPage: typeof currentPage !== 'undefined' ? currentPage : 'dashboard' }) %>

        <div class="flex-1 flex flex-col overflow-hidden ml-56">
            <%- include('partials/warning-banner') %>
            <header class="bg-white border-b border-gray-200 px-4 py-2"><h1 class="text-lg font-semibold text-gray-900">Dashboard</h1></header>
            <main class="flex-1 overflow-y-auto p-3 space-y-3">
                <div class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-2">
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Accounts</p>
                        <p class="metric-value text-2xl font-bold text-gray-900" id="totalAccounts">0</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Monitoring</p>
                        <p class="metric-value text-2xl font-bold text-gray-900" id="monitoringCount">0</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Live Now</p>
                        <p class="metric-value text-2xl font-bold text-green-600" id="liveCount">0</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Alerts</p>
                        <p class="metric-value text-2xl font-bold text-red-600" id="alertsCount">0</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Sessions</p>
                        <p class="metric-value text-2xl font-bold text-gray-900" id="sessionsCount">0</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded p-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">New Alerts</p>
                        <p class="metric-value text-2xl font-bold text-orange-600" id="newAlertsCount">0</p>
                    </div>
                </div>

                <div class="bg-white border border-gray-200 rounded overflow-hidden">
                    <div class="px-3 py-2 border-b border-gray-200"><h3 class="text-sm font-semibold text-gray-900">Recent Alerts</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Account</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Trigger Word</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        async function loadStats() {
            try {
                const [accounts, monitoring, alerts, sessions] = await Promise.all([
                    api.get('/tikusers'),
                    api.get('/monitor/status'),
                    api.get('/alerts'),
                    api.get('/live/sessions')
                ]);

                document.getElementById('totalAccounts').textContent = accounts.length;
                document.getElementById('monitoringCount').textContent = monitoring.filter(a => a.monitoring).length;
                document.getElementById('liveCount').textContent = monitoring.filter(a => a.currentLiveSessionId).length;
                document.getElementById('alertsCount').textContent = alerts.length;
                document.getElementById('sessionsCount').textContent = sessions.length;
                document.getElementById('newAlertsCount').textContent = alerts.filter(a => a.status === 'new').length;

                const recentAlerts = alerts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
                const tbody = document.getElementById('alertsTableBody');
                if (recentAlerts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">No alerts</td></tr>';
                } else {
                    tbody.innerHTML = recentAlerts.map(alert => {
                        const severityClass = {
                            low: 'bg-blue-100 text-blue-800',
                            medium: 'bg-yellow-100 text-yellow-800',
                            high: 'bg-red-100 text-red-800'
                        }[alert.severity] || 'bg-gray-100 text-gray-800';
                        const statusClass = {
                            new: 'text-red-600',
                            acknowledged: 'text-yellow-600',
                            resolved: 'text-green-600'
                        }[alert.status] || 'text-gray-600';

                        return `
                            <tr class="table-row">
                                <td class="px-3 py-2 metric-value text-gray-900">${new Date(alert.timestamp).toLocaleString()}</td>
                                <td class="px-3 py-2 font-medium text-gray-900">@${alert.handle}</td>
                                <td class="px-3 py-2 text-gray-600">${alert.triggerWord}</td>
                                <td class="px-3 py-2"><span class="px-1.5 py-0.5 text-xs font-medium rounded ${severityClass}">${alert.severity.toUpperCase()}</span></td>
                                <td class="px-3 py-2 ${statusClass}">${alert.status}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Load stats error:', error);
            }
        }

        let socket = null;
        if (typeof io !== 'undefined') {
            socket = io();
            socket.on('newAlert', () => loadStats());
            socket.on('liveSessionStarted', () => loadStats());
            socket.on('liveSessionEnded', () => loadStats());
        }

        loadStats();
        setInterval(loadStats, 30000);
    </script>
<%- include('partials/footer') %>
