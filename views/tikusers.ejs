<%- include('partials/head') %>
    <div class="flex h-screen overflow-hidden">
        <%- include('partials/sidebar', { currentPage: typeof currentPage !== 'undefined' ? currentPage : 'tikusers' }) %>

        <div class="flex-1 flex flex-col overflow-hidden ml-56">
            <%- include('partials/warning-banner') %>
            <header class="bg-white border-b border-gray-200 px-4 py-2">
                <h1 class="text-lg font-semibold text-gray-900">T-Users & Monitoring</h1>
            </header>
            <main class="flex-1 overflow-y-auto p-3 space-y-3">
                <div class="bg-white border border-gray-200 rounded p-3">
                    <div class="flex items-end gap-3">
                        <div class="flex-1" style="max-width: 40%;">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Add TikTok Account</h3>
                            <div class="flex gap-2">
                                <input type="text" id="addHandleInput" placeholder="@username" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-900 focus:border-blue-900">
                                <button onclick="addAccount()" id="addButton" class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded hover:bg-gray-800 disabled:opacity-50">Add</button>
                            </div>
                            <div id="addError" class="hidden text-xs text-red-600 mt-2"></div>
                        </div>
                        <div class="flex-1 flex items-end justify-end gap-2">
                            <button onclick="exportToExcel()" id="exportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export to Excel
                            </button>
                            <button onclick="checkAll()" id="checkAllBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700">Check All</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white border border-gray-200 rounded overflow-hidden">
                    <div class="px-3 py-2 border-b border-gray-200"><h3 class="text-sm font-semibold text-gray-900">TikTok Accounts & Monitoring</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Profile</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Handle</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Nickname</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Monitoring</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Last Live</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Last Checked</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Followers</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Last Synced</th>
                                    <th class="px-3 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="10" class="px-3 py-4 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit Account</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <form id="editForm" class="space-y-4">
                <!-- Basic Info Section -->
                <div class="border-b border-gray-200 pb-3">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Basic Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Handle</label><input type="text" id="editHandle" class="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">User ID</label><input type="text" id="editId" class="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Unique ID</label><input type="text" id="editUniqueId" class="w-full px-3 py-2 border border-gray-300 rounded text-sm bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Nickname</label><input type="text" id="editNickname" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div class="col-span-2"><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Signature / Bio</label><textarea id="editBio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></textarea></div>
                        <div class="col-span-2"><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Profile Picture URL</label><input type="text" id="editProfilePictureUrl" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="border-b border-gray-200 pb-3">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Status</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="editVerified" class="rounded border-gray-300">
                            <label for="editVerified" class="text-xs font-medium text-gray-700 uppercase tracking-wide">Verified</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="editSecret" class="rounded border-gray-300">
                            <label for="editSecret" class="text-xs font-medium text-gray-700 uppercase tracking-wide">Secret</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="editPrivateAccount" class="rounded border-gray-300">
                            <label for="editPrivateAccount" class="text-xs font-medium text-gray-700 uppercase tracking-wide">Private Account</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="editUseSession" class="rounded border-gray-300">
                            <label for="editUseSession" class="text-xs font-medium text-gray-700 uppercase tracking-wide">Use Session</label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Use Session: when enabled, monitoring will use the captured TikTok login session to bypass audience controls (see Sessions page).</p>
                </div>

                <!-- Location & Language Section -->
                <div class="border-b border-gray-200 pb-3">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Location & Language</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Language</label><input type="text" id="editLanguage" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Region</label><input type="text" id="editRegion" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div class="border-b border-gray-200 pb-3">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Statistics</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Followers</label><input type="number" id="editFollowerCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Following</label><input type="number" id="editFollowingCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Videos</label><input type="number" id="editVideoCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Likes (Hearts)</label><input type="number" id="editHeartCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Digg Count</label><input type="number" id="editDiggCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Friends</label><input type="number" id="editFriendCount" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"></div>
                    </div>
                </div>

                <!-- Account Info Section -->
                <div class="border-b border-gray-200 pb-3">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Account Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">SecUid</label><input type="text" id="editSecUid" class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono text-xs bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Creation Date</label><input type="text" id="editCreationDate" class="w-full px-3 py-2 border border-gray-300 rounded text-sm metric-value bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Last Username Change</label><input type="text" id="editUniqueIdModifyTime" class="w-full px-3 py-2 border border-gray-300 rounded text-sm metric-value bg-gray-100" readonly></div>
                        <div><label class="block text-xs font-medium text-gray-700 uppercase tracking-wide mb-1">Last Nickname Change</label><input type="text" id="editNickNameModifyTime" class="w-full px-3 py-2 border border-gray-300 rounded text-sm metric-value bg-gray-100" readonly></div>
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="submit" class="flex-1 px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded hover:bg-gray-800">Save</button>
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-50">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Change History</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div id="historyContent" class="space-y-2"><p class="text-sm text-gray-500">Loading...</p></div>
        </div>
    </div>

    <!-- Profile Image Modal -->
    <div id="profileImageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeProfileImage()">
        <div class="relative max-w-4xl max-h-full" onclick="event.stopPropagation()">
            <button onclick="closeProfileImage()" class="absolute top-2 right-2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <div class="bg-white rounded-lg p-4">
                <div class="text-center mb-3">
                    <h3 id="modalNickname" class="text-lg font-semibold text-gray-900"></h3>
                    <p id="modalHandle" class="text-sm text-gray-600"></p>
                </div>
                <img id="modalProfileImage" src="" alt="Profile" class="max-w-full max-h-[80vh] rounded-lg object-contain mx-auto" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjIwMCIgY3k9IjE2MCIgcj0iNjAiIGZpbGw9IiM5QkEzQUYiLz4KPHBhdGggZD0iTTIwMCAyNDBDMTY3LjQgMjQwIDE0MCAyNjcuNCAxNDAgMzAwVjM0MEgyNjBWMzAwQzI2MCAyNjcuNCAyMzIuNiAyNDAgMjAwIDI0MFoiIGZpbGw9IiM5QkEzQUYiLz4KPC9zdmc+'">
            </div>
        </div>
    </div>

    <script type="module">
        let accounts = [];
        let currentEditHandle = null;
        let currentHistoryHandle = null;
        let socket = null;

        // Initialize Socket.IO (loaded via CDN in head.ejs)
        if (typeof io !== 'undefined') {
            socket = io();
            
            socket.on('monitoringStatusChanged', () => {
                console.log('[Socket.IO] Monitoring status changed, reloading accounts...');
                loadAccounts();
            });
            
            socket.on('liveSessionStarted', () => {
                console.log('[Socket.IO] Live session started, reloading accounts...');
                loadAccounts();
            });
            
            socket.on('liveSessionEnded', () => {
                console.log('[Socket.IO] Live session ended, reloading accounts...');
                loadAccounts();
            });
        }

        async function loadAccounts() {
            try {
                // Use /api/monitor/status which merges both account and monitoring data
                accounts = await api.get('/monitor/status');
                renderAccounts();
            } catch (error) {
                document.getElementById('accountsTableBody').innerHTML = `<tr><td colspan="9" class="px-3 py-4 text-center text-red-600">Error: ${error.message}</td></tr>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderAccounts() {
            const tbody = document.getElementById('accountsTableBody');
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-3 py-4 text-center text-gray-500">No accounts yet. Add one above.</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(account => {
                // Status determination
                const isLive = account.currentLiveSessionId ? true : false;
                const statusClass = isLive ? 'text-green-600 font-medium' : 'text-gray-500';
                const statusText = isLive ? 'LIVE' : 'Offline';
                
                // Monitoring status
                const monitoringEnabled = account.monitoring || false;
                
            // Format date helper function
            const formatDate = (date) => {
                if (!date) return 'N/A';
                let dateObj;
                if (date instanceof Date) {
                    dateObj = date;
                } else if (typeof date === 'string') {
                    dateObj = new Date(date);
                } else if (typeof date === 'number') {
                    // Check if Unix timestamp in seconds (< 10000000000) or milliseconds
                    dateObj = date < 10000000000 ? new Date(date * 1000) : new Date(date);
                } else {
                    return 'N/A';
                }
                if (isNaN(dateObj.getTime())) return 'N/A';
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            const formatDateTime = (date) => {
                if (!date) return 'Never';
                let dateObj;
                if (date instanceof Date) {
                    dateObj = date;
                } else if (typeof date === 'string') {
                    dateObj = new Date(date);
                } else if (typeof date === 'number') {
                    dateObj = date < 10000000000 ? new Date(date * 1000) : new Date(date);
                } else {
                    return 'Never';
                }
                if (isNaN(dateObj.getTime())) return 'Never';
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            };
            
            // Last live time
            const lastLiveDisplay = formatDateTime(account.lastLiveTime);
            
            // Last checked
            const lastCheckedDisplay = formatDateTime(account.lastCheckedAt);
                
                // Nickname
                const nickname = account.nickname || account.handle || '-';
                
                // Profile picture URL
                const profilePicUrl = account.profilePictureUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNGM0Y0RjYiLz4KPHBhdGggZD0iTTMyIDI0QzI4LjY4IDI0IDI2IDI2LjY4IDI2IDMwQzI2IDMzLjMyIDI4LjY4IDM2IDMyIDM2QzM1LjMyIDM2IDM4IDMzLjMyIDM4IDMwQzM4IDI2LjY4IDM1LjMyIDI0IDMyIDI0Wk0zMiA0MEMyNy41ODQgNDAgMjQgNDIuNTg0IDI0IDQ3VjUwSDQwVjQ3QzQwIDQyLjU4NCAzNi40MTYgNDAgMzIgNDBaIiBmaWxsPSIjOUJBM0FGIi8+Cjwvc3ZnPg==';
                
                // Last synced (already defined formatDateTime above)
                const lastSyncedDisplay = formatDateTime(account.lastSyncedAt);
                
                return `
                    <tr class="table-row hover:bg-gray-50" data-handle="${account.handle}">
                        <td class="px-3 py-2">
                            <button onclick="toggleExpand('${account.handle}')" class="mr-1 text-gray-400 hover:text-gray-600 transition-transform" id="expandBtn-${account.handle}">
                                <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            <img src="${profilePicUrl}" 
                                 alt="${escapeHtml(nickname)}" 
                                 class="w-16 h-16 rounded-full object-cover border-2 border-gray-200 cursor-pointer hover:opacity-80 transition-opacity inline-block" 
                                 onclick="showProfileImage('${profilePicUrl.replace(/'/g, "\\'")}', '${escapeHtml(nickname).replace(/'/g, "\\'")}', '@${account.handle}')" 
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNGM0Y0RjYiLz4KPHBhdGggZD0iTTMyIDI0QzI4LjY4IDI0IDI2IDI2LjY4IDI2IDMwQzI2IDMzLjMyIDI4LjY4IDM2IDMyIDM2QzM1LjMyIDM2IDM4IDMzLjMyIDM4IDMwQzM4IDI2LjY4IDM1LjMyIDI0IDMyIDI0Wk0zMiA0MEMyNy41ODQgNDAgMjQgNDIuNTg0IDI0IDQ3VjUwSDQwVjQ3QzQwIDQyLjU4NCAzNi40MTYgNDAgMzIgNDBaIiBmaWxsPSIjOUJBM0FGIi8+Cjwvc3ZnPg==';">
                        </td>
                        <td class="px-3 py-2 font-medium text-gray-900">@${escapeHtml(account.handle)}</td>
                        <td class="px-3 py-2 text-gray-700">${escapeHtml(nickname)}</td>
                        <td class="px-3 py-2"><span class="${statusClass}">${statusText}</span></td>
                        <td class="px-3 py-2">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       class="sr-only peer" 
                                       ${monitoringEnabled ? 'checked' : ''}
                                       onchange="toggleMonitoring('${account.handle}', this.checked); this.nextElementSibling.nextElementSibling.textContent = this.checked ? 'ON' : 'OFF'">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                <span class="ml-2 text-xs text-gray-700 font-medium">${monitoringEnabled ? 'ON' : 'OFF'}</span>
                            </label>
                        </td>
                        <td class="px-3 py-2 text-gray-600 metric-value text-xs">${lastLiveDisplay}</td>
                        <td class="px-3 py-2 text-gray-600 metric-value text-xs">${lastCheckedDisplay}</td>
                        <td class="px-3 py-2 metric-value text-gray-900">${(account.followerCount || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-gray-600 text-xs">${lastSyncedDisplay}</td>
                        <td class="px-3 py-2">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 space-y-1">
                                <!-- Top row: Sync, Edit, Changes, Delete -->
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="syncAccount('${account.handle}')" id="syncBtn-${account.handle}" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors" title="Sync">Sync</button>
                                    <button onclick="editAccount('${account.handle}')" class="px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700" title="Edit">Edit</button>
                                    <button onclick="viewHistory('${account.handle}')" class="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700" title="Account Changes History">Changes</button>
                                    <button onclick="deleteAccount('${account.handle}')" class="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700" title="Delete">Delete</button>
                                </div>
                                <!-- Bottom row: Check, Watch Live, History Sessions -->
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="checkNow('${account.handle}')" id="checkBtn-${account.handle}" class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700" title="Check Live">Check</button>
                                    <button onclick="watchLive('${account.handle}')" id="watchLiveBtn-${account.handle}" ${isLive && account.currentLiveSessionId ? '' : 'disabled'} class="px-2 py-1 text-xs ${isLive && account.currentLiveSessionId ? 'bg-orange-600 text-white hover:bg-orange-700' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}" title="Watch Live Session">Watch Live</button>
                                    <button onclick="viewSessionHistory('${account.handle}')" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700" title="Live Session History">History</button>
                                </div>
                                </div>
                                <button onclick="toggleExpand('${account.handle}')" class="ml-2 text-gray-400 hover:text-gray-600 transition-transform flex-shrink-0" id="expandBtnRight-${account.handle}">
                                    <svg class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr id="expandRow-${account.handle}" class="hidden bg-gray-100">
                        <td colspan="10" class="px-3 py-4 border-t-2 border-gray-400">
                            <div id="analyticsContent-${account.handle}" class="text-xs">
                                <div class="text-center text-gray-500 py-4">
                                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900"></div>
                                    <p class="mt-2">Loading analytics...</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function addAccount() {
            const input = document.getElementById('addHandleInput');
            const handle = input.value.trim();
            const errorDiv = document.getElementById('addError');
            const button = document.getElementById('addButton');
            
            if (!handle) {
                errorDiv.textContent = 'Please enter a handle';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            errorDiv.classList.add('hidden');
            button.disabled = true;
            button.textContent = 'Adding...';
            
            try {
                await api.post('/tikusers', { handle });
                input.value = '';
                await loadAccounts();
                showSuccess('Account added successfully!');
                errorDiv.classList.add('hidden');
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                showError(`Failed to add account: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Add';
            }
        }

        async function syncAccount(handle) {
            const button = document.getElementById(`syncBtn-${handle}`);
            if (!button) return;
            
            const originalText = button.textContent;
            const originalClasses = button.className;
            button.disabled = true;
            button.textContent = 'Syncing...';
            button.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                await api.post(`/tikusers/${handle}/sync`);
                await loadAccounts();
                
                button.textContent = '✓ Synced';
                button.classList.remove('bg-blue-600');
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.className = originalClasses;
                }, 2000);
                
                showSuccess('Account synced successfully!');
            } catch (error) {
                button.disabled = false;
                button.textContent = originalText;
                button.className = originalClasses;
                showError(`Sync failed: ${error.message}`);
            }
        }

        async function toggleMonitoring(handle, enabled) {
            try {
                await api.put(`/monitor/${handle}/toggle`, { enabled });
                await loadAccounts();
            } catch (error) {
                showError(`Failed to toggle monitoring: ${error.message}`);
                // Reload to reset UI state
                await loadAccounts();
            }
        }

        async function checkNow(handle) {
            const button = document.getElementById(`checkBtn-${handle}`);
            if (!button) return;
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Checking...';
            button.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                const result = await api.post(`/monitor/${handle}/check-now`, {});
                
                if (result.isLive) {
                    button.textContent = '✓ LIVE!';
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-green-700');
                } else {
                    button.textContent = '✗ Offline';
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-gray-600');
                }
                
                await loadAccounts();
                
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-green-700', 'bg-gray-600');
                    button.classList.add('bg-green-600');
                }, 2000);
            } catch (error) {
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                showError(`Failed to check account: ${error.message}`);
            }
        }

        async function exportToExcel() {
            try {
                const exportBtn = document.getElementById('exportBtn');
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Exporting...';
                
                // Create a link to download the file
                const link = document.createElement('a');
                link.href = '/api/tikusers/export/excel';
                link.download = `tiktok_accounts_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showToast('Export started! File will download shortly.', 'success');
                
                // Reset button after a delay
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }, 2000);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting to Excel. Please try again.', 'error');
                const exportBtn = document.getElementById('exportBtn');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Export to Excel';
            }
        }

        async function checkAll() {
            const button = document.getElementById('checkAllBtn');
            if (!button) return;
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Checking...';
            button.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                await api.post('/monitor/check-all', {});
                await loadAccounts();
                
                button.textContent = '✓ Checked';
                button.classList.remove('bg-blue-600');
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                    button.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-green-600');
                    button.classList.add('bg-blue-600');
                }, 2000);
            } catch (error) {
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                showError(`Failed to check all accounts: ${error.message}`);
            }
        }

        function editAccount(handle) {
            const account = accounts.find(a => a.handle === handle);
            if (!account) return;
            
            currentEditHandle = handle;
            
            // Basic Info
            document.getElementById('editHandle').value = account.handle || '';
            document.getElementById('editId').value = account.id || '';
            document.getElementById('editUniqueId').value = account.uniqueId || account.handle || '';
            document.getElementById('editNickname').value = account.nickname || '';
            document.getElementById('editBio').value = account.bio || account.signature || '';
            document.getElementById('editProfilePictureUrl').value = account.profilePictureUrl || '';
            
            // Status
            document.getElementById('editVerified').checked = account.verified || account.secret || false;
            document.getElementById('editSecret').checked = account.secret || false;
            document.getElementById('editPrivateAccount').checked = account.privateAccount || false;
            document.getElementById('editUseSession').checked = account.useSession || false;
            
            // Location & Language
            document.getElementById('editLanguage').value = account.language || '';
            document.getElementById('editRegion').value = account.region || '';
            
            // Statistics
            document.getElementById('editFollowerCount').value = account.followerCount || 0;
            document.getElementById('editFollowingCount').value = account.followingCount || 0;
            document.getElementById('editVideoCount').value = account.videoCount || 0;
            document.getElementById('editHeartCount').value = account.heartCount || 0;
            document.getElementById('editDiggCount').value = account.diggCount || 0;
            document.getElementById('editFriendCount').value = account.friendCount || 0;
            
            // Account Info
            document.getElementById('editSecUid').value = account.secUid || '';
            
            // Format date helper function for edit modal
            const formatDateForInput = (date) => {
                if (!date) return 'N/A';
                let dateObj;
                if (typeof date === 'number') {
                    // Check if Unix timestamp in seconds (< 10000000000) or milliseconds
                    dateObj = date < 10000000000 ? new Date(date * 1000) : new Date(date);
                } else if (typeof date === 'string') {
                    dateObj = new Date(date);
                } else {
                    return 'N/A';
                }
                if (isNaN(dateObj.getTime())) return 'N/A';
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            document.getElementById('editCreationDate').value = formatDateForInput(account.createTime || account.creationDate);
            document.getElementById('editUniqueIdModifyTime').value = formatDateForInput(account.uniqueIdModifyTime);
            document.getElementById('editNickNameModifyTime').value = formatDateForInput(account.nickNameModifyTime);
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditHandle = null;
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentEditHandle) return;
            
            try {
                const data = {
                    uniqueId: document.getElementById('editUniqueId').value,
                    nickname: document.getElementById('editNickname').value,
                    bio: document.getElementById('editBio').value,
                    signature: document.getElementById('editBio').value,
                    profilePictureUrl: document.getElementById('editProfilePictureUrl').value,
                    verified: document.getElementById('editVerified').checked,
                    secret: document.getElementById('editSecret').checked,
                    privateAccount: document.getElementById('editPrivateAccount').checked,
                    language: document.getElementById('editLanguage').value,
                    region: document.getElementById('editRegion').value,
                    followerCount: parseInt(document.getElementById('editFollowerCount').value) || 0,
                    followingCount: parseInt(document.getElementById('editFollowingCount').value) || 0,
                    videoCount: parseInt(document.getElementById('editVideoCount').value) || 0,
                    heartCount: parseInt(document.getElementById('editHeartCount').value) || 0,
                    diggCount: parseInt(document.getElementById('editDiggCount').value) || 0,
                    friendCount: parseInt(document.getElementById('editFriendCount').value) || 0,
                    secUid: document.getElementById('editSecUid').value,
                    useSession: document.getElementById('editUseSession').checked
                };
                
                await api.put(`/tikusers/${currentEditHandle}`, data);
                closeEditModal();
                await loadAccounts();
                showSuccess('Account updated successfully!');
            } catch (error) {
                showError(`Update failed: ${error.message}`);
            }
        });

        async function viewHistory(handle) {
            currentHistoryHandle = handle;
            document.getElementById('historyModal').classList.remove('hidden');
            const content = document.getElementById('historyContent');
            content.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
            
            try {
                const history = await api.get(`/tikusers/${handle}/history`);
                if (history.length === 0) {
                    content.innerHTML = '<p class="text-sm text-gray-500">No history available.</p>';
                    return;
                }
                
                content.innerHTML = history.map(item => `
                    <div class="border border-gray-200 rounded p-3">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-gray-900 uppercase">${escapeHtml(item.field)}</span>
                            <span class="text-xs text-gray-500 metric-value">${new Date(item.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            <div><span class="font-medium">From:</span> ${escapeHtml(item.oldValue || '(empty)')}</div>
                            <div><span class="font-medium">To:</span> ${escapeHtml(item.newValue || '(empty)')}</div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Source: ${escapeHtml(item.source)}</div>
                    </div>
                `).join('');
            } catch (error) {
                content.innerHTML = `<p class="text-sm text-red-600">Error: ${error.message}</p>`;
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            currentHistoryHandle = null;
        }

        async function deleteAccount(handle) {
            if (!confirm(`Are you sure you want to delete @${handle}?`)) return;
            
            try {
                await api.delete(`/tikusers/${handle}`);
                await loadAccounts();
                showSuccess('Account deleted successfully!');
            } catch (error) {
                showError(`Delete failed: ${error.message}`);
            }
        }

        function showProfileImage(imageUrl, nickname, handle) {
            const modal = document.getElementById('profileImageModal');
            const modalImage = document.getElementById('modalProfileImage');
            const modalNickname = document.getElementById('modalNickname');
            const modalHandle = document.getElementById('modalHandle');
            
            modalImage.src = imageUrl;
            modalNickname.textContent = nickname;
            modalHandle.textContent = handle;
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeProfileImage() {
            const modal = document.getElementById('profileImageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProfileImage();
                closeEditModal();
                closeHistoryModal();
            }
        });

        function watchLive(handle) {
            // Get current session for this handle
            const account = accounts.find(a => a.handle === handle);
            if (account && account.currentLiveSessionId) {
                // Redirect to live-view with session ID
                window.location.href = `/live-view?sessionId=${account.currentLiveSessionId}`;
            } else {
                showWarning(`No active live session for @${handle}`);
            }
        }

        function viewSessionHistory(handle) {
            // Redirect to history page with handle filter
            window.location.href = `/history?handle=${handle}`;
        }

        // Expand/collapse analytics row
        const expandedRows = new Set();
        
        async function toggleExpand(handle) {
            const row = document.getElementById(`expandRow-${handle}`);
            const button = document.getElementById(`expandBtn-${handle}`);
            const buttonRight = document.getElementById(`expandBtnRight-${handle}`);
            const content = document.getElementById(`analyticsContent-${handle}`);
            
            if (expandedRows.has(handle)) {
                // Collapse
                row.classList.add('hidden');
                if (button) button.querySelector('svg').classList.remove('rotate-90');
                if (buttonRight) buttonRight.querySelector('svg').classList.remove('rotate-90');
                expandedRows.delete(handle);
            } else {
                // Expand
                row.classList.remove('hidden');
                if (button) button.querySelector('svg').classList.add('rotate-90');
                if (buttonRight) buttonRight.querySelector('svg').classList.add('rotate-90');
                expandedRows.add(handle);
                
                // Load analytics if not loaded yet
                if (!content.dataset.loaded) {
                    await loadUserAnalytics(handle);
                }
            }
        }

        async function loadUserAnalytics(handle) {
            const content = document.getElementById(`analyticsContent-${handle}`);
            if (!content) return;
            
            try {
                // Fetch user analytics
                const analytics = await api.get(`/tikusers/${handle}/analytics`);
                
                // Render analytics content
                content.innerHTML = renderAnalytics(analytics, handle);
                content.dataset.loaded = 'true';
            } catch (error) {
                console.error(`Error loading analytics for @${handle}:`, error);
                content.innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        <p>Error loading analytics: ${escapeHtml(error.message)}</p>
                    </div>
                `;
            }
        }

        function renderAnalytics(data, handle) {
            const {
                accountInfo,
                last7Days,
                allTimeStats,
                sessionFreq,
                recentSessions,
                activityChart
            } = data;
            
            // Format date helper
            const formatCreateTime = (timestamp) => {
                if (!timestamp) return 'N/A';
                let dateObj;
                if (typeof timestamp === 'number') {
                    // Check if Unix timestamp in seconds (< 10000000000) or milliseconds
                    dateObj = timestamp < 10000000000 ? new Date(timestamp * 1000) : new Date(timestamp);
                } else if (typeof timestamp === 'string') {
                    dateObj = new Date(timestamp);
                } else {
                    return 'N/A';
                }
                if (isNaN(dateObj.getTime())) return 'N/A';
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                return `${day}/${month}/${year}`;
            };
            
            // Calculate session frequency info
            const avgSessionsPerDay = sessionFreq.totalSessions > 0 
                ? (sessionFreq.totalSessions / Math.max(sessionFreq.daysTracked || 1, 1)).toFixed(1)
                : '0';
            
            const maxDay = sessionFreq.dailyBreakdown && sessionFreq.dailyBreakdown.length > 0
                ? sessionFreq.dailyBreakdown.reduce((max, day) => day.sessions > max.sessions ? day : max, sessionFreq.dailyBreakdown[0])
                : null;
            
            // Format duration
            const formatDuration = (seconds) => {
                if (!seconds) return '0m';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                }
                return `${minutes}m`;
            };
            
            // Create sparkline chart for activity
            const createSparkline = (values, maxVal) => {
                if (!values || values.length === 0) return '';
                const width = 200;
                const height = 40;
                const points = values.map((val, i) => {
                    const x = (i / (values.length - 1 || 1)) * width;
                    const y = height - (val / (maxVal || 1)) * height;
                    return `${x},${y}`;
                }).join(' ');
                return `<svg class="w-full h-10" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <polyline points="${points}" fill="none" stroke="#1E3A8A" stroke-width="1.5" class="sparkline"/>
                </svg>`;
            };
            
            return `
                <div class="space-y-3">
                    <!-- User Info Section -->
                    <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                        <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">Account Intelligence</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">User ID</p>
                                <p class="metric-value text-sm font-bold text-gray-900">${accountInfo.id || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Verified</p>
                                <p class="text-sm font-medium ${accountInfo.verified ? 'text-green-600' : 'text-gray-500'}">${accountInfo.verified ? '✓ Yes' : '✗ No'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Private</p>
                                <p class="text-sm font-medium ${accountInfo.privateAccount ? 'text-red-600' : 'text-gray-500'}">${accountInfo.privateAccount ? '✓ Yes' : '✗ No'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Language</p>
                                <p class="metric-value text-sm font-medium text-gray-900">${accountInfo.language || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Region</p>
                                <p class="metric-value text-sm font-medium text-gray-900">${accountInfo.region || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Account Created</p>
                                <p class="metric-value text-xs font-medium text-gray-900">${formatCreateTime(accountInfo.createTime)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Last 7 Days Statistics -->
                    <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                        <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">Last 7 Days Performance</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Sessions</p>
                                <p class="metric-value text-lg font-bold text-gray-900">${last7Days.totalSessions || 0}</p>
                                <p class="text-xs text-gray-500">${last7Days.totalDuration ? formatDuration(last7Days.totalDuration) : '0m'} total</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Likes</p>
                                <p class="metric-value text-lg font-bold text-green-600">${(last7Days.totalLikes || 0).toLocaleString()}</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Viewers</p>
                                <p class="metric-value text-lg font-bold text-blue-600">${(last7Days.maxViewers || 0).toLocaleString()}</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Gifts</p>
                                <p class="metric-value text-lg font-bold text-purple-600">${(last7Days.totalGifts || 0).toLocaleString()}</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Messages</p>
                                <p class="metric-value text-lg font-bold text-indigo-600">${(last7Days.totalMessages || 0).toLocaleString()}</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Follows</p>
                                <p class="metric-value text-lg font-bold text-yellow-600">${(last7Days.totalFollows || 0).toLocaleString()}</p>
                            </div>
                            <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Shares</p>
                                <p class="metric-value text-lg font-bold text-orange-600">${(last7Days.totalShares || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Chart & Session Frequency -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                        <!-- Activity Trend -->
                        <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">Activity Trend (7d)</h4>
                            ${activityChart && activityChart.length > 0 ? createSparkline(activityChart, Math.max(...activityChart)) : '<p class="text-xs text-gray-500 text-center py-4">No activity data</p>'}
                            <div class="mt-2 flex justify-between text-xs text-gray-500">
                                <span>Day 1</span>
                                <span>Day 7</span>
                            </div>
                        </div>

                        <!-- Session Frequency -->
                        <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                            <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">Session Frequency</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600">Total Sessions</span>
                                    <span class="metric-value text-sm font-bold text-gray-900">${sessionFreq.totalSessions || 0}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600">Avg/Day</span>
                                    <span class="metric-value text-sm font-bold text-gray-900">${avgSessionsPerDay}</span>
                                </div>
                                ${maxDay ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs text-gray-600">Peak Day</span>
                                        <span class="metric-value text-xs font-medium text-gray-900">${formatCreateTime(new Date(maxDay.date).getTime() / 1000)} (${maxDay.sessions} sessions)</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- All-Time Statistics -->
                    <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                        <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">All-Time Statistics</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Sessions</p>
                                <p class="metric-value text-lg font-bold text-gray-900">${allTimeStats.totalSessions || 0}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Time</p>
                                <p class="metric-value text-sm font-bold text-gray-900">${allTimeStats.totalDuration ? formatDuration(allTimeStats.totalDuration) : '0m'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Likes</p>
                                <p class="metric-value text-lg font-bold text-green-600">${(allTimeStats.totalLikes || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Viewers</p>
                                <p class="metric-value text-lg font-bold text-blue-600">${(allTimeStats.maxViewers || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Gifts</p>
                                <p class="metric-value text-lg font-bold text-purple-600">${(allTimeStats.totalGifts || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Messages</p>
                                <p class="metric-value text-lg font-bold text-indigo-600">${(allTimeStats.totalMessages || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Follows</p>
                                <p class="metric-value text-lg font-bold text-yellow-600">${(allTimeStats.totalFollows || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Shares</p>
                                <p class="metric-value text-lg font-bold text-orange-600">${(allTimeStats.totalShares || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Reposts</p>
                                <p class="metric-value text-lg font-bold text-teal-600">${(allTimeStats.totalReposts || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Subscribes</p>
                                <p class="metric-value text-lg font-bold text-pink-600">${(allTimeStats.totalSubscribes || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Avg Session Time</p>
                                <p class="metric-value text-sm font-bold text-gray-900">${allTimeStats.avgSessionDuration ? formatDuration(allTimeStats.avgSessionDuration) : '0m'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Peak Viewers</p>
                                <p class="metric-value text-lg font-bold text-red-600">${(allTimeStats.peakViewers || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Sessions -->
                    <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                        <h4 class="text-xs font-semibold text-gray-900 uppercase tracking-wide mb-3">Recent Live Sessions</h4>
                        ${recentSessions && recentSessions.length > 0 ? `
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${recentSessions.slice(0, 5).map(session => {
                                    const startTime = new Date(session.startTime);
                                    const endTime = session.endTime ? new Date(session.endTime) : null;
                                    const duration = endTime ? Math.floor((endTime - startTime) / 1000) : null;
                                    
                                    return `
                                        <div class="border border-gray-200 rounded p-2 hover:bg-gray-50 cursor-pointer" onclick="window.location.href='/live-view?sessionId=${session.sessionId}'">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-xs font-medium text-gray-900">${startTime.toLocaleString()}</span>
                                                <span class="text-xs ${session.status === 'live' ? 'text-green-600' : 'text-gray-500'} font-medium">${session.status.toUpperCase()}</span>
                                            </div>
                                            <div class="grid grid-cols-4 gap-2 text-xs">
                                                <div>
                                                    <span class="text-gray-500">Duration:</span>
                                                    <span class="metric-value font-medium text-gray-900 ml-1">${duration ? formatDuration(duration) : 'Ongoing'}</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-500">Likes:</span>
                                                    <span class="metric-value font-medium text-green-600 ml-1">${(session.stats?.totalLikes || 0).toLocaleString()}</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-500">Viewers:</span>
                                                    <span class="metric-value font-medium text-blue-600 ml-1">${(session.stats?.totalViewers || 0).toLocaleString()}</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-500">Messages:</span>
                                                    <span class="metric-value font-medium text-indigo-600 ml-1">${(session.stats?.totalMessages || 0).toLocaleString()}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${recentSessions.length > 5 ? `
                                <div class="mt-2 text-center">
                                    <button onclick="viewSessionHistory('${handle}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium">View All ${recentSessions.length} Sessions →</button>
                                </div>
                            ` : ''}
                        ` : '<p class="text-xs text-gray-500 text-center py-4">No live sessions recorded</p>'}
                    </div>
                </div>
            `;
        }

        // Expose functions to window
        window.addAccount = addAccount;
        window.syncAccount = syncAccount;
        window.editAccount = editAccount;
        window.closeEditModal = closeEditModal;
        window.viewHistory = viewHistory;
        window.closeHistoryModal = closeHistoryModal;
        window.deleteAccount = deleteAccount;
        window.toggleMonitoring = toggleMonitoring;
        window.checkNow = checkNow;
        window.checkAll = checkAll;
        window.exportToExcel = exportToExcel;
        window.showProfileImage = showProfileImage;
        window.closeProfileImage = closeProfileImage;
        window.watchLive = watchLive;
        window.viewSessionHistory = viewSessionHistory;
        window.toggleExpand = toggleExpand;

        // Load accounts on page load
        loadAccounts();
    </script>
    <%- include('partials/toast-notifications') %>
<%- include('partials/footer') %>
